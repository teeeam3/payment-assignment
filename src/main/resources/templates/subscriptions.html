<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <title>êµ¬ë… ê´€ë¦¬ - Commerce Demo</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <script th:src="@{/js/cookie-util.js}"></script>
    <script th:src="@{/js/app-config.js}"></script>
    <script th:src="@{/js/api-handler.js}"></script>
    <script th:src="@{/js/api-validator.js}"></script>
    <script th:src="@{/js/theme.js}"></script>
    <script th:src="@{/js/portone-sdk.js}"></script>
    <script th:src="@{/js/auth-check.js}"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">ğŸª CommerceHub</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">í™ˆ</a></li>
                <li><a href="/pages/shop" class="nav-link">ìƒì </a></li>
                <li><a href="/pages/orders" class="nav-link">ì£¼ë¬¸</a></li>
                <li><a href="/pages/points" class="nav-link">í¬ì¸íŠ¸</a></li>
                <li><a href="/pages/plans" class="nav-link">í”Œëœ</a></li>
                <li><a href="/pages/subscribe" class="nav-link">êµ¬ë… ì‹ ì²­</a></li>
                <li><a href="/pages/subscriptions" class="nav-link active">êµ¬ë… ê´€ë¦¬</a></li>
            </ul>
            <div class="navbar-actions">
                <div class="config-badge-container"></div>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-area">
            <h1 style="font-size: 2rem; margin-bottom: 2rem;">ğŸ”„ êµ¬ë… ê´€ë¦¬</h1>

            <div class="card">
                <div class="card-header">êµ¬ë… ì •ë³´</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">êµ¬ë… ID</label>
                        <input type="text" id="subscription-id" class="form-input" placeholder="sub_123456">
                    </div>
                    <button class="btn btn-outline" onclick="getSubscription()">
                        ğŸ” êµ¬ë… ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>

                    <!-- êµ¬ë… ìƒì„¸ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="subscription-details" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">ğŸ“‹ êµ¬ë… ìƒì„¸</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">í”Œëœ ID:</span>
                                <span id="sub-plan-id" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">êµ¬ë… ê¸ˆì•¡:</span>
                                <span id="sub-amount" style="font-weight: 600; color: var(--success);"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">ìƒíƒœ:</span>
                                <span id="sub-status" style="font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">í˜„ì¬ ì´ìš© ê¸°ê°„ ì¢…ë£Œì¼:</span>
                                <span id="sub-period-end" style="font-weight: 600; color: var(--primary);"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">ê³ ê° UID:</span>
                                <span id="sub-customer-uid" style="font-family: monospace; font-size: 0.875rem;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸ’° ì²­êµ¬ ì‘ì—…</div>
                <div class="card-subtitle">êµ¬ë… ì²­êµ¬ ê´€ë¦¬</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>â„¹ï¸ ì•ˆë‚´:</strong> ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì²­êµ¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                        ì´ ë²„íŠ¼ë“¤ë¡œ ì²­êµ¬ ì‘ì—…ì„ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="executeBilling()">
                            ğŸ’³ í˜„ì¬ ì£¼ê¸° ì²­êµ¬ ì‹¤í–‰
                        </button>
                        <button class="btn btn-secondary" onclick="getBillingHistory()">
                            ğŸ“‹ ì²­êµ¬ ë‚´ì—­ ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">âš™ï¸ êµ¬ë… ê´€ë¦¬</div>
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="cancelSubscription()">
                            âŒ êµ¬ë… í•´ì§€
                        </button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸ“‹ ì‚¬ìš© ì•ˆë‚´</div>
                <div class="card-body">
                    <ol style="margin-left: 1.5rem; line-height: 2;">
                        <li><a href="/pages/subscribe" style="color: var(--primary);">/subscribe</a> í˜ì´ì§€ì—ì„œ êµ¬ë… ìƒì„± </li>
                        <li>ë°›ì€ êµ¬ë… ID ì…ë ¥</li>
                        <li>"êµ¬ë… ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°</li>
                        <li>"í˜„ì¬ ì£¼ê¸° ì²­êµ¬ ì‹¤í–‰"ì„ ì‚¬ìš©í•˜ì—¬ ì •ê¸° ê²°ì œ í…ŒìŠ¤íŠ¸</li>
                        <li>"ì²­êµ¬ ë‚´ì—­ ë³´ê¸°"ë¡œ ëª¨ë“  ê³¼ê±° ì²­êµ¬ í™•ì¸</li>
                        <li>"êµ¬ë… í•´ì§€"ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë… ì¢…ë£Œ</li>
                    </ol>
                </div>
            </div>

            <div id="billing-history-container" style="margin-top: 1.5rem; display: none;">
                <div class="card">
                    <div class="card-header">ğŸ“Š ì²­êµ¬ ë‚´ì—­</div>
                    <div class="card-body">
                        <div id="billing-history-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="api-panel">
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¡ í˜„ì¬ ì—”ë“œí¬ì¸íŠ¸</h3>
                <div id="current-endpoint" class="endpoint-badge">ì•„ì§ ìš”ì²­ ì—†ìŒ</div>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¤ ìš”ì²­</h3>
                <textarea id="request-body" class="api-textarea"></textarea>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¥ ì‘ë‹µ</h3>
                <pre id="response-output" class="response-box">ìš”ì²­ ëŒ€ê¸° ì¤‘...</pre>
            </div>
        </div>
    </div>

    <script>
        // Get subscriptionId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const subscriptionIdParam = urlParams.get('subscriptionId');
        if (subscriptionIdParam) {
            document.getElementById('subscription-id').value = subscriptionIdParam;
        }

        async function getSubscription() {
            const subscriptionId = document.getElementById('subscription-id').value.trim();
            if (!subscriptionId) {
                showNotification('âš ï¸ êµ¬ë… IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            try {
                const subscription = await makeApiRequest('get-subscription', {
                    pathParams: subscriptionId
                });

                // êµ¬ë… ì •ë³´ í‘œì‹œ
                document.getElementById('sub-plan-id').textContent = subscription.planId;
                document.getElementById('sub-amount').textContent = `â‚©${subscription.amount.toLocaleString()}`;
                document.getElementById('sub-status').textContent = subscription.status;
                document.getElementById('sub-customer-uid').textContent = subscription.customerUid;

                // í˜„ì¬ ì´ìš© ê¸°ê°„ ì¢…ë£Œì¼ í¬ë§·íŒ…
                const periodEnd = subscription.currentPeriodEnd
                    ? subscription.currentPeriodEnd.substring(0, 19).replace('T', ' ')
                    : 'N/A';
                document.getElementById('sub-period-end').textContent = periodEnd;

                // êµ¬ë… ìƒì„¸ ì˜ì—­ í‘œì‹œ
                document.getElementById('subscription-details').style.display = 'block';

                showNotification('êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('Failed to get subscription:', error);

                // êµ¬ë… ìƒì„¸ ì˜ì—­ ìˆ¨ê¹€
                document.getElementById('subscription-details').style.display = 'none';

                // API ë¯¸êµ¬í˜„ ì—ëŸ¬ ì²˜ë¦¬
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showNotification('âš ï¸ êµ¬ë… ì¡°íšŒ APIê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GET /api/subscriptions/{subscriptionId} ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('500') || error.message.includes('501')) {
                    showNotification('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API êµ¬í˜„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification(`êµ¬ë… ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        async function executeBilling() {
            const subscriptionId = document.getElementById('subscription-id').value.trim();
            if (!subscriptionId) {
                showNotification('âš ï¸ êµ¬ë… IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!confirm('í˜„ì¬ ì£¼ê¸° ì²­êµ¬ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì²­êµ¬ ê¸°ê°„ ê³„ì‚° (1ê°œì›”)
                const now = new Date();
                const periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

                await makeApiRequest('create-billing', {
                    pathParams: subscriptionId,
                    body: {
                        periodStart: periodStart.toISOString(),
                        periodEnd: periodEnd.toISOString()
                    }
                });
                showNotification('ì²­êµ¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                console.error('Failed to execute billing:', error);

                // API ë¯¸êµ¬í˜„ ì—ëŸ¬ ì²˜ë¦¬
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showNotification('âš ï¸ ì²­êµ¬ ìƒì„± APIê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. POST /api/subscriptions/{subscriptionId}/billings ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('500') || error.message.includes('501')) {
                    showNotification('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API êµ¬í˜„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification(`ì²­êµ¬ ì‹¤í–‰ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        async function getBillingHistory() {
            const subscriptionId = document.getElementById('subscription-id').value.trim();
            if (!subscriptionId) {
                showNotification('âš ï¸ êµ¬ë… IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            try {
                const result = await makeApiRequest('list-billing-history', {
                    pathParams: subscriptionId
                });

                // Display billing history
                const container = document.getElementById('billing-history-container');
                const listDiv = document.getElementById('billing-history-list');

                if (result.billings && result.billings.length > 0) {
                    listDiv.innerHTML = result.billings.map(billing => {
                        // ë‚ ì§œ í¬ë§·íŒ… (YYYY-MM-DDë§Œ í‘œì‹œ)
                        const periodStart = billing.periodStart ? billing.periodStart.substring(0, 10) : '';
                        const periodEnd = billing.periodEnd ? billing.periodEnd.substring(0, 10) : '';

                        // ìƒíƒœ ìƒ‰ìƒ
                        let statusColor = 'var(--text-secondary)';
                        if (billing.status === 'COMPLETED') statusColor = 'var(--success)';
                        else if (billing.status === 'FAILED') statusColor = 'var(--danger)';

                        return `
                            <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${periodStart} ~ ${periodEnd}</strong>
                                        <div style="color: ${statusColor}; font-size: 0.875rem; margin-top: 0.25rem;">
                                            ${billing.status}${billing.failureMessage ? ` - ${billing.failureMessage}` : ''}
                                        </div>
                                    </div>
                                    <span style="color: var(--success); font-weight: 600;">â‚©${billing.amount.toLocaleString()}</span>
                                </div>
                                ${billing.attemptDate ? `
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                                        ê²°ì œ ì‹œë„: ${billing.attemptDate.substring(0, 19).replace('T', ' ')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    listDiv.innerHTML = '<p style="color: var(--text-secondary);">ì²­êµ¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                }

                container.style.display = 'block';
                showNotification('ì²­êµ¬ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('Failed to get billing history:', error);

                // API ë¯¸êµ¬í˜„ ì—ëŸ¬ ì²˜ë¦¬
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showNotification('âš ï¸ ì²­êµ¬ ë‚´ì—­ ì¡°íšŒ APIê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GET /api/subscriptions/{subscriptionId}/billings ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('500') || error.message.includes('501')) {
                    showNotification('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API êµ¬í˜„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification(`ì²­êµ¬ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        async function cancelSubscription() {
            const subscriptionId = document.getElementById('subscription-id').value.trim();
            if (!subscriptionId) {
                showNotification('âš ï¸ êµ¬ë… IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!confirm('ì •ë§ë¡œ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await makeApiRequest('update-subscription', {
                    pathParams: subscriptionId,
                    body: {
                        action: 'cancel',
                        reason: 'Customer request'
                    }
                });
                showNotification('êµ¬ë…ì´ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (error) {
                console.error('Failed to cancel subscription:', error);

                // API ë¯¸êµ¬í˜„ ì—ëŸ¬ ì²˜ë¦¬
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showNotification('âš ï¸ êµ¬ë… ì—…ë°ì´íŠ¸ APIê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. PATCH /api/subscriptions/{subscriptionId} ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('500') || error.message.includes('501')) {
                    showNotification('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API êµ¬í˜„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showNotification(`êµ¬ë… í•´ì§€ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }
    </script>
</body>
</html>
