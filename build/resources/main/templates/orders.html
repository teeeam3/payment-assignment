<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <title>ì£¼ë¬¸ - Commerce Demo</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <script th:src="@{/js/cookie-util.js}"></script>
    <script th:src="@{/js/app-config.js}"></script>
    <script th:src="@{/js/api-handler.js}"></script>
    <script th:src="@{/js/api-validator.js}"></script>
    <script th:src="@{/js/theme.js}"></script>
    <script th:src="@{/js/portone-sdk.js}"></script>
    <script th:src="@{/js/auth-check.js}"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">ğŸª CommerceHub</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">í™ˆ</a></li>
                <li><a href="/pages/shop" class="nav-link">ìƒì </a></li>
                <li><a href="/pages/orders" class="nav-link active">ì£¼ë¬¸</a></li>
                <li><a href="/pages/points" class="nav-link">í¬ì¸íŠ¸</a></li>
                <li><a href="/pages/plans" class="nav-link">í”Œëœ</a></li>
                <li><a href="/pages/subscribe" class="nav-link">êµ¬ë… ì‹ ì²­</a></li>
                <li><a href="/pages/subscriptions" class="nav-link">êµ¬ë… ê´€ë¦¬</a></li>
            </ul>
            <div class="navbar-actions">
                <div class="config-badge-container"></div>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-area">
            <h1 style="font-size: 2rem; margin-bottom: 2rem;">ğŸ“¦ ì£¼ë¬¸ ê´€ë¦¬</h1>

            <!-- API êµ¬í˜„ ìƒíƒœ ì•ˆë‚´ -->
            <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">âš ï¸ ë°±ì—”ë“œ API êµ¬í˜„ í•„ìš”</h4>
                <p style="margin: 0; font-size: 0.875rem; line-height: 1.6;">
                    ì´ í˜ì´ì§€ëŠ” ë‹¤ìŒ APIë“¤ì´ êµ¬í˜„ë˜ì–´ì•¼ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤:
                </p>
                <ul id="api-list-orders" style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem; line-height: 1.8;">
                    <!-- API ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </ul>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--text-secondary);">
                    ğŸ’¡ APIê°€ êµ¬í˜„ë˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë©°, ìš°ì¸¡ API íŒ¨ë„ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì£¼ë¬¸ ëª©ë¡ -->
            <div class="card">
                <div class="card-header">ë‚´ ì£¼ë¬¸ ëª©ë¡</div>
                <div class="card-body">
                    <div id="order-list-loading" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                    <div id="order-list-container" style="display: none;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                                    <th style="padding: 0.75rem;">ì£¼ë¬¸ ë²ˆí˜¸</th>
                                    <th style="padding: 0.75rem;">ì£¼ë¬¸ ID</th>
                                    <th style="padding: 0.75rem;">ê¸ˆì•¡</th>
                                    <th style="padding: 0.75rem;">í¬ì¸íŠ¸</th>
                                    <th style="padding: 0.75rem;">ìƒíƒœ</th>
                                    <th style="padding: 0.75rem; text-align: center;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="order-list-body">
                                <!-- ì£¼ë¬¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                    <div id="order-list-empty" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
                        ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. <a href="/pages/shop" style="color: var(--primary);">ìƒì </a>ì—ì„œ ì£¼ë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
                    </div>
                </div>
            </div>

            <!-- ëª¨ë“œ A: PortOne SDK -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸ”µ ëª¨ë“œ A (PortOne SDK)</div>
                <div class="card-subtitle">í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ PortOne ê²°ì œì°½ ì—´ê¸°</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        ìœ„ ì£¼ë¬¸ ëª©ë¡ì—ì„œ <strong>"ê²°ì œí•˜ê¸°"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤:
                        <ol style="margin: 1rem 0 0 1.5rem; line-height: 1.8;">
                            <li>ì„œë²„ì— ê²°ì œ ì‹œì‘ ìš”ì²­ (PENDING ìƒíƒœë¡œ DB ì €ì¥)</li>
                            <li>PortOne ê²°ì œì°½ ì—´ê¸°</li>
                            <li>ì‚¬ìš©ì ê²°ì œ ì§„í–‰</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- ëª¨ë“œ B: API ìˆ˜ë™ í…ŒìŠ¤íŠ¸ -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸŸ¢ ëª¨ë“œ B (API ìˆ˜ë™ í…ŒìŠ¤íŠ¸)</div>
                <div class="card-subtitle">ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸ ì§ì ‘ í˜¸ì¶œ</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        ê²°ì œ í™•ì •/ì·¨ì†Œ APIë¥¼ ì§ì ‘ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ê²°ì œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                    </div>

                    <div class="form-group">
                        <label class="form-label">ê²°ì œ ID</label>
                        <input type="text" id="manual-payment-id" class="form-input" placeholder="payment_xyz">
                    </div>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="manualConfirmPayment()">
                            âœ… ê²°ì œ í™•ì •
                        </button>
                        <button class="btn btn-danger" onclick="manualCancelPayment()">
                            âŒ ê²°ì œ ì·¨ì†Œ/í™˜ë¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ì•ˆë‚´ -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸ“‹ ì‚¬ìš© ì•ˆë‚´</div>
                <div class="card-body">
                    <h4 style="margin-bottom: 0.5rem;">ì¼ë°˜ ì‚¬ìš©ì íë¦„:</h4>
                    <ol style="margin-left: 1.5rem; line-height: 2;">
                        <li><a href="/pages/shop" style="color: var(--primary);">ìƒì </a>ì—ì„œ ì£¼ë¬¸ ìƒì„±</li>
                        <li>ìœ„ ì£¼ë¬¸ ëª©ë¡ì—ì„œ "ê²°ì œí•˜ê¸°" ë²„íŠ¼ í´ë¦­</li>
                        <li>PortOne ê²°ì œì°½ì—ì„œ ê²°ì œ ì§„í–‰</li>
                    </ol>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">ê°œë°œì í…ŒìŠ¤íŠ¸ (ëª¨ë“œ B):</h4>
                    <ol style="margin-left: 1.5rem; line-height: 2;">
                        <li>ê²°ì œ ì™„ë£Œ í›„ ë°›ì€ ê²°ì œ ID ì…ë ¥</li>
                        <li>"ê²°ì œ í™•ì •" ë˜ëŠ” "ê²°ì œ ì·¨ì†Œ/í™˜ë¶ˆ" ë²„íŠ¼ìœ¼ë¡œ API í…ŒìŠ¤íŠ¸</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="api-panel">
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¡ í˜„ì¬ ì—”ë“œí¬ì¸íŠ¸</h3>
                <div id="current-endpoint" class="endpoint-badge">ì•„ì§ ìš”ì²­ ì—†ìŒ</div>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¤ ìš”ì²­</h3>
                <textarea id="request-body" class="api-textarea"></textarea>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¥ ì‘ë‹µ</h3>
                <pre id="response-output" class="response-box">ìš”ì²­ ëŒ€ê¸° ì¤‘...</pre>
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
        let currentUser = null;
        let orders = [];

        // API ëª©ë¡ ë™ì  ìƒì„±
        async function populateApiList() {
            const apiListElement = document.getElementById('api-list-orders');
            if (!apiListElement) return;

            try {
                // config ë¡œë“œ ëŒ€ê¸°
                const config = await getConfig();
                const endpoints = config?.api?.endpoints;

                if (!endpoints) {
                    apiListElement.innerHTML = '';
                    return;
                }

                // orders.htmlì— í•„ìš”í•œ APIë“¤
                const requiredApis = ['list-orders', 'create-payment', 'confirm-payment', 'cancel-payment'];
                const apiItems = [];

                requiredApis.forEach(apiKey => {
                    const apiConfig = endpoints[apiKey];
                    if (apiConfig && apiConfig.url) {
                        const method = apiConfig.method || 'GET';
                        const description = apiConfig.description || '';
                        apiItems.push(`<li><code>${method} ${apiConfig.url}</code> - ${description}</li>`);
                    }
                });

                // APIê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
                apiListElement.innerHTML = apiItems.join('');
            } catch (error) {
                console.error('API ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                apiListElement.innerHTML = '';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            // API ëª©ë¡ ë™ì  ìƒì„± (ë¹„ë™ê¸°)
            populateApiList();


            await loadCurrentUser();
            await loadOrders();
        });

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadCurrentUser() {
            try {
                currentUser = await makeApiRequest('get-current-user', {
                });

                if (!validateApiResponse('get-current-user', currentUser)) {
                    throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
                currentUser = null;
            }
        }

        // ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ
        async function loadOrders() {
            const loadingEl = document.getElementById('order-list-loading');
            const containerEl = document.getElementById('order-list-container');
            const emptyEl = document.getElementById('order-list-empty');

            try {
                const result = await makeApiRequest('list-orders', {
                });

                // YML ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ìë™ ê²€ì¦
                if (!validateApiResponse('list-orders', result)) {
                    throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                orders = result;
                loadingEl.style.display = 'none';

                if (orders.length === 0) {
                    emptyEl.style.display = 'block';
                } else {
                    containerEl.style.display = 'block';
                    renderOrderList();
                }
            } catch (error) {
                console.error('Failed to load orders:', error);
                loadingEl.innerHTML = '<span style="color: var(--danger);">ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
            }
        }

        // ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§
        function renderOrderList() {
            const tbody = document.getElementById('order-list-body');
            tbody.innerHTML = '';

            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border)';

                // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼
                const statusStyle = getStatusStyle(order.status);

                // í¬ì¸íŠ¸ ì •ë³´ êµ¬ì„±
                const usedPoints = order.usedPoints || 0;
                const earnedPoints = order.earnedPoints || 0;
                const finalAmount = order.finalAmount || order.totalAmount;

                let pointsDisplay = '';
                if (usedPoints > 0 || earnedPoints > 0) {
                    pointsDisplay = '<div style="font-size: 0.875rem;">';
                    if (usedPoints > 0) {
                        pointsDisplay += `<div style="color: var(--danger);">-${usedPoints.toLocaleString()}P</div>`;
                    }
                    if (earnedPoints > 0) {
                        pointsDisplay += `<div style="color: var(--success);">+${earnedPoints.toLocaleString()}P</div>`;
                    }
                    pointsDisplay += '</div>';
                } else {
                    pointsDisplay = '<span style="color: var(--text-secondary); font-size: 0.875rem;">-</span>';
                }

                tr.innerHTML = `
                    <td style="padding: 0.75rem; font-weight: 600;">${order.orderNumber}</td>
                    <td style="padding: 0.75rem; font-family: monospace; font-size: 0.875rem; color: var(--text-secondary);">${order.orderId}</td>
                    <td style="padding: 0.75rem;">
                        <div style="font-weight: 600;">${order.totalAmount.toLocaleString()}ì›</div>
                        ${usedPoints > 0 ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">ì‹¤ê²°ì œ: ${finalAmount.toLocaleString()}ì›</div>` : ''}
                    </td>
                    <td style="padding: 0.75rem;">
                        ${pointsDisplay}
                    </td>
                    <td style="padding: 0.75rem;">
                        <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500; ${statusStyle}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td style="padding: 0.75rem; text-align: center;">
                        ${order.status === 'PENDING' ?
                            `<button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="payOrder('${order.orderId}', ${finalAmount})">
                                ğŸ’³ ê²°ì œí•˜ê¸°
                            </button>` :
                            `<span style="color: var(--text-secondary); font-size: 0.875rem;">-</span>`
                        }
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // ì£¼ë¬¸ ê²°ì œí•˜ê¸°
        async function payOrder(orderId, totalAmount) {
            if (!currentUser) {
                showNotification('âš ï¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            // í•´ë‹¹ ì£¼ë¬¸ ì°¾ê¸°
            const order = orders.find(o => o.orderId === orderId);
            if (!order) {
                showNotification('âš ï¸ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            try {
                const paymentData = {
                    orderId: orderId,
                    orderName: `ì£¼ë¬¸ ${order.orderNumber}`,  // ì£¼ë¬¸ ë²ˆí˜¸ë¡œ í‘œì‹œ
                    totalAmount: totalAmount,
                    currency: 'KRW',
                    payMethod: 'CARD',
                    customer: {
                        customerId: currentUser.customerUid,  // PortOneì— ì „ë‹¬í•  ê³ ê° UID
                        fullName: currentUser.name,
                        phoneNumber: currentUser.phone || '01012345678',  // KG ì´ë‹ˆì‹œìŠ¤ í•„ìˆ˜
                        email: currentUser.email
                    }
                };

                const result = await openPortOnePayment(paymentData);

                if (result.paymentId) {
                    // ê²°ì œ ì™„ë£Œ í›„ ëª¨ë“œ Bì— ìë™ ì…ë ¥
                    document.getElementById('manual-payment-id').value = result.paymentId;

                    showNotification('ğŸ’³ ê²°ì œ ì™„ë£Œ! ì•„ë˜ì—ì„œ ê²°ì œ í™•ì •/ì·¨ì†Œë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');

                    // ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadOrders();
                }
            } catch (error) {
                console.error('Payment failed:', error);
            }
        }

        // ëª¨ë“œ B: ìˆ˜ë™ ê²°ì œ í™•ì •
        async function manualConfirmPayment() {
            const paymentId = document.getElementById('manual-payment-id').value.trim();

            if (!paymentId) {
                showNotification('âš ï¸ ê²°ì œ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            try {
                await confirmPaymentTemplate(paymentId);
                await loadOrders(); // ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('Failed to confirm payment:', error);
            }
        }

        // ëª¨ë“œ B: ìˆ˜ë™ ê²°ì œ ì·¨ì†Œ
        async function manualCancelPayment() {
            const paymentId = document.getElementById('manual-payment-id').value.trim();

            if (!paymentId) {
                showNotification('âš ï¸ ê²°ì œ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!confirm('ì •ë§ ì´ ê²°ì œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await cancelPaymentTemplate(paymentId, 'Customer request');
                await loadOrders(); // ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('Failed to cancel payment:', error);
            }
        }

        // ìƒíƒœ ìŠ¤íƒ€ì¼ ë°˜í™˜
        function getStatusStyle(status) {
            const styles = {
                'PENDING': 'background: #FEF3C7; color: #92400E;',
                'PAID': 'background: #D1FAE5; color: #065F46;',
                'CANCELLED': 'background: #FEE2E2; color: #991B1B;',
                'SHIPPED': 'background: #DBEAFE; color: #1E40AF;',
                'DELIVERED': 'background: #E0E7FF; color: #3730A3;'
            };
            return styles[status] || 'background: #F3F4F6; color: #374151;';
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getStatusText(status) {
            const texts = {
                'PENDING': 'ê²°ì œ ëŒ€ê¸°',
                'PAID': 'ê²°ì œ ì™„ë£Œ',
                'CANCELLED': 'ì·¨ì†Œë¨',
                'SHIPPED': 'ë°°ì†¡ì¤‘',
                'DELIVERED': 'ë°°ì†¡ ì™„ë£Œ'
            };
            return texts[status] || status;
        }
    </script>
</body>
</html>
