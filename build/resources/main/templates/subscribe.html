<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
    <title>êµ¬ë… ì‹ ì²­ - Commerce Demo</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <script th:src="@{/js/cookie-util.js}"></script>
    <script th:src="@{/js/app-config.js}"></script>
    <script th:src="@{/js/api-handler.js}"></script>
    <script th:src="@{/js/api-validator.js}"></script>
    <script th:src="@{/js/theme.js}"></script>
    <script th:src="@{/js/portone-sdk.js}"></script>
    <script th:src="@{/js/auth-check.js}"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">ğŸª CommerceHub</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">í™ˆ</a></li>
                <li><a href="/pages/shop" class="nav-link">ìƒì </a></li>
                <li><a href="/pages/orders" class="nav-link">ì£¼ë¬¸</a></li>
                <li><a href="/pages/points" class="nav-link">í¬ì¸íŠ¸</a></li>
                <li><a href="/pages/plans" class="nav-link">í”Œëœ</a></li>
                <li><a href="/pages/subscribe" class="nav-link active">êµ¬ë… ì‹ ì²­</a></li>
                <li><a href="/pages/subscriptions" class="nav-link">êµ¬ë… ê´€ë¦¬</a></li>
            </ul>
            <div class="navbar-actions">
                <div class="config-badge-container"></div>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-area">
            <h1 style="font-size: 2rem; margin-bottom: 2rem;">ğŸ’³ í”Œëœ êµ¬ë… ì‹ ì²­</h1>

            <div class="card">
                <div class="card-header">ì„ íƒí•œ í”Œëœ</div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">í”Œëœ ID</label>
                        <input type="text" id="plan-id" class="form-input" placeholder="BASIC, PRO, MAX">
                    </div>
                    <div id="plan-details" style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: 1rem;">
                        <p style="color: var(--text-secondary);">í”Œëœì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <!-- êµ¬ë… ì‹ ì²­ (í†µí•©) -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">ğŸš€ êµ¬ë… ì‹ ì²­</div>
                <div class="card-subtitle">ë¹Œë§í‚¤ ë°œê¸‰ë¶€í„° êµ¬ë… ìƒì„±ê¹Œì§€ ìë™ ì²˜ë¦¬</div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <strong>â„¹ï¸ í˜„ì¬ ì‚¬ìš©ì:</strong> <span id="current-user-email">ë¡œë”© ì¤‘...</span><br>
                        <strong>ê³ ê° UID:</strong> <span id="current-customer-id">ë¡œë”© ì¤‘...</span>
                    </div>

                    <button id="subscribe-btn" class="btn btn-primary" onclick="startSubscription()" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                        ğŸš€ êµ¬ë… ì‹ ì²­ ì‹œì‘
                    </button>

                    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
                    <div id="progress-tracker" style="display: none; margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">ì§„í–‰ ìƒí™©</h4>

                        <div id="step-1" class="progress-step">
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-secondary);">
                                <div class="step-icon" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; background: var(--bg);">1</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">ë¹Œë§í‚¤ ë°œê¸‰</div>
                                    <div class="step-status" style="font-size: 0.875rem; color: var(--text-secondary);">PortOne SDK í˜¸ì¶œ</div>
                                </div>
                                <div class="step-result" style="font-size: 1.5rem;"></div>
                            </div>
                        </div>

                        <div id="step-2" class="progress-step" style="margin-top: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-secondary);">
                                <div class="step-icon" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; background: var(--bg);">2</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">êµ¬ë… ìƒì„±</div>
                                    <div class="step-status" style="font-size: 0.875rem; color: var(--text-secondary);">POST /api/subscriptions (ê²°ì œìˆ˜ë‹¨ ë“±ë¡ í¬í•¨)</div>
                                </div>
                                <div class="step-result" style="font-size: 1.5rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ìµœì¢… ê²°ê³¼ -->
                    <div id="final-result" style="display: none; margin-top: 1.5rem;"></div>
                </div>
            </div>
        </div>

        <div class="api-panel">
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¡ í˜„ì¬ ì—”ë“œí¬ì¸íŠ¸</h3>
                <div id="current-endpoint" class="endpoint-badge">ì•„ì§ ìš”ì²­ ì—†ìŒ</div>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¤ ìš”ì²­</h3>
                <textarea id="request-body" class="api-textarea"></textarea>
            </div>
            <div class="panel-section">
                <h3 class="panel-title">ğŸ“¥ ì‘ë‹µ</h3>
                <pre id="response-output" class="response-box">ìš”ì²­ ëŒ€ê¸° ì¤‘...</pre>
            </div>
        </div>
    </div>

    <script>
        // í”Œëœ ì •ë³´ (ì„œë²„ì—ì„œ ë¡œë“œ)
        let plans = null;

        // í”Œëœ ì´ëª¨ì§€ ë§¤í•‘
        const planEmojis = {
            'BASIC': 'ğŸ¥‰',
            'PRO': 'ğŸ¥ˆ',
            'MAX': 'ğŸ¥‡'
        };

        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ (ì„œë²„ì—ì„œ ë¡œë“œ)
        let currentUser = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function loadCurrentUser() {
            try {
                currentUser = await makeApiRequest('get-current-user', {
                });

                // YML ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ìë™ ê²€ì¦
                if (!validateApiResponse('get-current-user', currentUser)) {
                    showNotification('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    setTimeout(() => window.location.href = '/pages/login', 2000);
                    return;
                }

                document.getElementById('current-user-email').textContent = currentUser.email;
                document.getElementById('current-customer-id').textContent = currentUser.customerUid;
            } catch (error) {
                console.error('Failed to load user info:', error);
                showNotification('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        // í”Œëœ ëª©ë¡ ë¡œë“œ
        async function loadPlans() {
            try {
                const plansArray = await makeApiRequest('list-plans', {
                });

                if (!validateApiResponse('list-plans', plansArray)) {
                    throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // ë°°ì—´ì„ ê°ì²´ë¡œ ë³€í™˜ (planIdë¥¼ ê·¸ëŒ€ë¡œ í‚¤ë¡œ ì‚¬ìš©)
                plans = {};
                plansArray.forEach(plan => {
                    // planIdë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì–´ë–¤ í˜•ì‹ì´ë“  ìƒê´€ì—†ìŒ: PLAN-PRO, PRO, 1, etc.)
                    plans[plan.planId] = {
                        planId: plan.planId,
                        name: plan.name,
                        price: plan.amount,
                        billingCycle: plan.billingCycle,
                        // ì´ëª¨ì§€ ë§¤í•‘: name ê¸°ë°˜ ë˜ëŠ” ê¸°ë³¸ê°’
                        emoji: planEmojis[plan.name.toUpperCase()] || planEmojis[plan.planId] || 'ğŸ“¦'
                    };
                });

                console.log('Loaded plans:', plans);
            } catch (error) {
                console.error('Failed to load plans:', error);

                // API ë¯¸êµ¬í˜„ ë©”ì‹œì§€ í‘œì‹œ
                const mainContent = document.querySelector('.container');
                mainContent.innerHTML = `
                    <div class="alert alert-warning" style="margin-top: 2rem;">
                        <h3>âš ï¸ API ë¯¸êµ¬í˜„</h3>
                        <p><strong>GET /api/plans</strong> ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.</p>
                        <p>êµ¬ë… í”Œëœ ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” APIê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <p style="margin-top: 1rem;">
                            <a href="/pages/plans" class="btn btn-primary">í”Œëœ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                        </p>
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadPlans();
        });

        // URLì—ì„œ palnId ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const planIdParam = urlParams.get('planId');
        if (planIdParam) {
            document.getElementById('plan-id').value = planIdParam;
            updatePlanDetails(planIdParam);
        }

        document.getElementById('plan-id').addEventListener('change', (e) => {
            updatePlanDetails(e.target.value);
        });

        // í”Œëœ ì°¾ê¸° í—¬í¼ (ìœ ì—°í•œ ë§¤ì¹­: ì •í™•í•œ ì¼ì¹˜ â†’ name ì¼ì¹˜ â†’ ë¶€ë¶„ ì¼ì¹˜)
        function findPlan(searchKey) {
            if (!plans || !searchKey) return null;

            // 1. ì •í™•í•œ planId ì¼ì¹˜
            if (plans[searchKey]) return plans[searchKey];

            // 2. ëŒ€ì†Œë¬¸ì ë¬´ì‹œ planId ì¼ì¹˜
            const lowerSearch = searchKey.toLowerCase();
            for (const [planId, plan] of Object.entries(plans)) {
                if (planId.toLowerCase() === lowerSearch) return plan;
            }

            // 3. name ì¼ì¹˜ (ì˜ˆ: "PRO" â†’ nameì´ "Pro"ì¸ í”Œëœ)
            for (const plan of Object.values(plans)) {
                if (plan.name.toUpperCase() === searchKey.toUpperCase()) return plan;
            }

            // 4. planIdì— ê²€ìƒ‰í‚¤ê°€ í¬í•¨ëœ ê²½ìš° (ì˜ˆ: "PRO" â†’ "PLAN-PRO")
            for (const [planId, plan] of Object.entries(plans)) {
                if (planId.toUpperCase().includes(searchKey.toUpperCase())) return plan;
            }

            return null;
        }

        function updatePlanDetails(searchKey) {
            const plan = findPlan(searchKey);
            const detailsDiv = document.getElementById('plan-details');

            if (plan) {
                detailsDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 3rem;">${plan.emoji}</div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${plan.name}</div>
                            <div style="font-size: 1.25rem; color: var(--primary);">â‚©${plan.price.toLocaleString()}/month</div>
                        </div>
                    </div>
                `;
            }
        }

        // ========================================
        // í†µí•© êµ¬ë… ì‹ ì²­ í”Œë¡œìš°
        // ========================================
        async function startSubscription() {
            const planIdInput = document.getElementById('plan-id').value.trim();

            // ìœ ì—°í•œ í”Œëœ ì°¾ê¸° (ì–´ë–¤ planId í˜•ì‹ì´ë“  ë§¤ì¹­)
            const plan = findPlan(planIdInput);

            if (!plan) {
                showNotification('âš ï¸ Please select a valid plan', 'warning');
                return;
            }

            if (!currentUser) {
                showNotification('âš ï¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('subscribe-btn').disabled = true;
            document.getElementById('progress-tracker').style.display = 'block';
            document.getElementById('final-result').style.display = 'none';

            resetProgressStep(1);
            resetProgressStep(2);

            let billingKey = null;

            try {
                // ============================================
                // Step 1: ë¹Œë§í‚¤ ë°œê¸‰ (PortOne SDK)
                // ============================================
                updateStepStatus(1, 'progress', 'ì§„í–‰ì¤‘... PortOne ì°½ì´ ì—´ë¦½ë‹ˆë‹¤');

                const billingKeyData = {
                    issueId: `issue_${Date.now()}`,
                    issueName: `${plan.name} Plan Subscription`,
                    billingKeyMethod: 'CARD',
                    customer: {
                        customerId: currentUser.customerUid,
                        fullName: currentUser.name,
                        phoneNumber: currentUser.phone || '01012345678',  // KG ì´ë‹ˆì‹œìŠ¤ í•„ìˆ˜
                        email: currentUser.email
                    }
                };

                const billingKeyResult = await issuePortOneBillingKey(billingKeyData);

                if (!billingKeyResult.billingKey) {
                    throw new Error('ë¹Œë§í‚¤ ë°œê¸‰ ì‹¤íŒ¨');
                }

                billingKey = billingKeyResult.billingKey;
                updateStepStatus(1, 'success', `ì™„ë£Œ! (${billingKey.substring(0, 20)}...)`);
                console.log('âœ“ Step 1: ë¹Œë§í‚¤ ë°œê¸‰ ì™„ë£Œ:', billingKey);

                // ============================================
                // Step 2: êµ¬ë… ìƒì„± (ê²°ì œìˆ˜ë‹¨ ë“±ë¡ í¬í•¨)
                // ============================================
                updateStepStatus(2, 'progress', 'ì§„í–‰ì¤‘... POST /api/subscriptions');

                let subscriptionResult;
                try {
                    subscriptionResult = await makeApiRequest('create-subscription', {
                        body: {
                            customerUid: currentUser.customerUid,
                            planId: plan.planId,  // APIì—ì„œ ë°›ì€ planId ê·¸ëŒ€ë¡œ ì „ì†¡
                            billingKey: billingKey,
                            amount: plan.price
                        }
                    });
                } catch (apiError) {
                    // API ë¯¸êµ¬í˜„ ìƒíƒœë¥¼ stepì— í‘œì‹œ
                    if (apiError.message.includes('404') || apiError.message.includes('Not Found')) {
                        updateStepStatus(2, 'error', 'âŒ API ë¯¸êµ¬í˜„ (POST /api/subscriptions ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”)');
                    } else {
                        updateStepStatus(2, 'error', `âŒ ì‹¤íŒ¨: ${apiError.message}`);
                    }
                    throw apiError;
                }

                // ì‘ë‹µ ê²€ì¦
                if (!subscriptionResult.subscriptionId) {
                    updateStepStatus(2, 'error', 'âŒ êµ¬ë… IDê°€ ë°˜í™˜ë˜ì§€ ì•ŠìŒ');
                    throw new Error('êµ¬ë… IDê°€ ë°˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }

                updateStepStatus(2, 'success', 'ì™„ë£Œ! êµ¬ë… í™œì„±í™”ë¨ (ê²°ì œìˆ˜ë‹¨ë„ í•¨ê»˜ ë“±ë¡ë¨)');
                console.log('âœ“ Step 2: êµ¬ë… ìƒì„± ì™„ë£Œ (ê²°ì œìˆ˜ë‹¨ ë“±ë¡ í¬í•¨):', subscriptionResult.subscriptionId);

                // ============================================
                // ìµœì¢… ì„±ê³µ
                // ============================================
                showFinalResult('success', subscriptionResult.subscriptionId);

            } catch (error) {
                console.error('êµ¬ë… ì‹ ì²­ ì‹¤íŒ¨:', error);

                // API ë¯¸êµ¬í˜„ ì—¬ë¶€ íŒë‹¨
                let errorMessage = error.message;
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    errorMessage = 'âš ï¸ êµ¬ë… ìƒì„± APIê°€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°±ì—”ë“œì—ì„œ POST /api/subscriptions ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('500') || error.message.includes('501')) {
                    errorMessage = 'âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API êµ¬í˜„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }

                showFinalResult('error', null, errorMessage);
            } finally {
                document.getElementById('subscribe-btn').disabled = false;
            }
        }

        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        function updateStepStatus(stepNumber, status, message) {
            const step = document.getElementById(`step-${stepNumber}`);
            const statusDiv = step.querySelector('.step-status');
            const resultDiv = step.querySelector('.step-result');
            const icon = step.querySelector('.step-icon');

            statusDiv.textContent = message;

            if (status === 'progress') {
                icon.style.background = 'var(--primary)';
                icon.style.color = 'white';
                resultDiv.textContent = 'â³';
            } else if (status === 'success') {
                icon.style.background = 'var(--success)';
                icon.style.color = 'white';
                resultDiv.textContent = 'âœ…';
            } else if (status === 'error') {
                icon.style.background = 'var(--danger)';
                icon.style.color = 'white';
                resultDiv.textContent = 'âŒ';
            }
        }

        // ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
        function resetProgressStep(stepNumber) {
            const step = document.getElementById(`step-${stepNumber}`);
            const statusDiv = step.querySelector('.step-status');
            const resultDiv = step.querySelector('.step-result');
            const icon = step.querySelector('.step-icon');

            icon.style.background = 'var(--bg)';
            icon.style.color = 'var(--text)';
            resultDiv.textContent = '';

            if (stepNumber === 1) statusDiv.textContent = 'PortOne SDK í˜¸ì¶œ';
            if (stepNumber === 2) statusDiv.textContent = 'POST /api/subscriptions (ê²°ì œìˆ˜ë‹¨ ë“±ë¡ í¬í•¨)';
        }

        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        function showFinalResult(status, subscriptionId, errorMessage) {
            const resultDiv = document.getElementById('final-result');
            resultDiv.style.display = 'block';

            if (status === 'success') {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h3 style="margin: 0 0 0.5rem 0;">ğŸ‰ êµ¬ë… ì‹ ì²­ ì™„ë£Œ!</h3>
                        <p style="margin: 0;">êµ¬ë… ID: <code>${subscriptionId}</code></p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">ì ì‹œ í›„ êµ¬ë… ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
                    </div>
                `;

                setTimeout(() => {
                    window.location.href = `/pages/subscriptions?subscriptionId=${subscriptionId}`;
                }, 2000);
            } else {
                // API ë¯¸êµ¬í˜„ ì—¬ë¶€ì— ë”°ë¼ ë„ì›€ë§ ì œê³µ
                const isApiNotImplemented = errorMessage.includes('êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤') || errorMessage.includes('API ë¯¸êµ¬í˜„');

                let helpText = '';
                if (isApiNotImplemented) {
                    helpText = `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-left: 4px solid var(--warning);">
                            <strong>ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:</strong><br>
                            <code style="background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; margin-top: 0.5rem;">POST /api/subscriptions</code> ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•˜ì„¸ìš”.<br>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">
                            â€¢ ìš”ì²­: customerUid, planId, billingKey, amount<br>
                            â€¢ ì‘ë‹µ: subscriptionId ë°˜í™˜<br>
                            â€¢ íŠ¸ëœì­ì…˜ ì²˜ë¦¬: ë¹Œë§í‚¤ ì €ì¥ + êµ¬ë… ìƒì„±
                            </small>
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h3 style="margin: 0 0 0.5rem 0;">âŒ êµ¬ë… ì‹ ì²­ ì‹¤íŒ¨</h3>
                        <p style="margin: 0; font-size: 0.875rem; line-height: 1.6;">${errorMessage || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                        ${helpText}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
